<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Fila | MOVIDA</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/fila.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>

    <header class="header">
        <div class="header-content">

            <div class="header-left">
                <img src="{{ url_for('static', filename='img/logo-icone.svg') }}" class="logo" alt="Logo Movida">
                <span class="header-brand">MOVIDA</span>
            </div>

            <h1 class="header-center">{{ empresa_nome }}</h1>

            <a href="{{ url_for('logout_cliente') }}" class="btn-sair">Sair</a>

        </div>
    </header>


    <main class="container">

        <p class="paciente-nome">{{ paciente_nome }}</p>

        <section class="status-grid">

            <div class="card">
                <h2>Posição atual</h2>
                <div id="posicao" class="big">{{ posicao }}</div>
                <p id="posicao_cor" class="subinfo">Carregando...</p>
            </div>

            <div class="card">
                <h2>Tempo médio</h2>
                <div id="tempo_medio" class="big">{{ tempo_medio }}</div>
            </div>

            <div class="card">
                <h2>Classificação</h2>
                <div id="classificacao" class="big classificacao tag-{{ paciente_classificacao|lower }}">
                    {{ paciente_classificacao }}
                </div>
            </div>

        </section>

        <section class="ultimos">
            <h3>Últimos atendidos</h3>
            <ul id="ultimos_list">
                <!-- atualizado via WebSocket -->
            </ul>
        </section>

        <!-- Tabela dos 4 primeiros da fila geral -->
        <section class="fila-geral">
            <h3>Próximos da fila geral</h3>

            <table class="fila-geral-table">
                <thead>
                    <tr>
                        <th>Posição</th>
                        <th>Nome</th>
                        <th>Classificação</th>
                    </tr>
                </thead>
                <tbody id="fila_geral_body">
                    <!-- preenchido via /api/primeiros_fila -->
                </tbody>
            </table>
        </section>

        <!-- Pacientes em atendimento -->
        <section class="em-atendimento">
            <h3>Pacientes em atendimento</h3>

            <table class="fila-geral-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Classificação</th>
                        <th>Início do Atendimento</th>
                    </tr>
                </thead>
                <tbody id="em_atendimento_body">
                    <!-- preenchido via /api/em_atendimento -->
                </tbody>
            </table>
        </section>

        <footer>
            <small>Atualizando em tempo real</small>
        </footer>

    </main>

    <script>
        const socket = io("/fila");

        socket.on("connect", () => {
            socket.emit("join_fila", {
                cpf: "{{ session['cliente_cpf'] }}"
            });
        });

        socket.on("fila_update", (d) => {

            // POSIÇÃO
            if (document.getElementById("posicao"))
                document.getElementById("posicao").innerText = d.posicao ?? "-";

            // TEMPO MÉDIO
            if (document.getElementById("tempo_medio"))
                document.getElementById("tempo_medio").innerText = d.tempo_medio ?? "-";

            // CLASSIFICAÇÃO
            const classDiv = document.getElementById("classificacao");
            if (classDiv) {
                classDiv.innerText = d.classificacao ?? "-";
                classDiv.className = "big classificacao tag-" + (d.classificacao || "").toLowerCase();
            }

            // ÚLTIMOS ATENDIDOS
            const ul = document.getElementById("ultimos_list");
            if (ul) {
                ul.innerHTML = "";
                (d.ultimos || []).forEach(u => {
                    const li = document.createElement("li");
                    li.innerHTML = `
                    <strong>${u.nome}</strong>
                    <span class="tag tag-${u.classificacao.toLowerCase()}">${u.classificacao}</span>
                    <span class="saida">${u.saida}</span>
                `;
                    ul.appendChild(li);
                });
            }

            // ---------------------------
            // ATUALIZA OS 4 PRIMEIROS DA FILA
            // ---------------------------
            fetch("/api/primeiros_fila")
                .then(r => r.json())
                .then(lista => {
                    const tbody = document.getElementById("fila_geral_body");
                    if (!tbody) return;

                    tbody.innerHTML = "";

                    lista.forEach(p => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                        <td>${p.posicao}</td>
                        <td>${p.nome}</td>
                        <td><span class="tag tag-${p.classificacao.toLowerCase()}">${p.classificacao}</span></td>
                    `;
                        tbody.appendChild(tr);
                    });
                });

            // ---------------------------
            // ATUALIZA PACIENTES EM ATENDIMENTO
            // ---------------------------
            fetch("/api/em_atendimento")
                .then(r => r.json())
                .then(lista => {
                    const tbody = document.getElementById("em_atendimento_body");
                    if (!tbody) return;

                    tbody.innerHTML = "";

                    lista.forEach(p => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                        <td>${p.nome}</td>
                        <td><span class="tag tag-${p.classificacao.toLowerCase()}">${p.classificacao}</span></td>
                        <td>${p.inicio}</td>
                    `;
                        tbody.appendChild(tr);
                    });
                });

        });
    </script>


</body>

</html>